<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Camera API</title>
        <link rel="stylesheet" href="css/base.css" type="text/css" media="screen">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="cognitive.js"></script>
    </head>

    <body>

        <div class="container">
            <h1>Camera API</h1>

            <section class="main-content">
                <p>Captura Imagen</p>
                <form enctype="multipart/form-data" method="post" name="fileinfo">
                    <p>
                        <input type="file" accept="image/*" name="avatar" id="take-picture" capture="user" />
                    </p>
                </form>                    
                    <span class="output"></span>
                    <h2>Preview:</h2>
                    <p>
                        <img src="about:blank" alt="" id="show-picture">
                    </p>

                    <p id="error"></p>

            
            </section>

            
        </div>


        <script>

            (function () {



                var takePicture = document.querySelector("#take-picture"),
                    showPicture = document.querySelector("#show-picture"),
                    output = document.querySelector(".output"),
                    imageURL = document.querySelector("#imageURL");
                

                    var form = document.forms.namedItem("fileinfo");
                    

                    if (takePicture && showPicture) {
                    // Set events
                    takePicture.onchange = function (event) {
                        // Get a reference to the taken picture or chosen file
                        var files = event.target.files,
                            file;
                        if (files && files.length > 0) {
                            file = files[0];
                            try {
                                // Create ObjectURL
                                var imgURL = window.URL.createObjectURL(file);

                                // Set img src to ObjectURL
                                showPicture.src = imgURL;
                                console.log(imgURL);
                                console.log("file:"+file);
                                // Revoke ObjectURL
                                //URL.revokeObjectURL(imgURL);
                                var data = new FormData(form)
                                
                                data.append("CustomField", "This is some extra data ");
                                // Perform the REST API call.
                                var xhr = new XMLHttpRequest();
                                xhr.open("POST", "http://localhost:3000/profile",false);
                                xhr.send(data);
                                var imageFile;
                                if (xhr.status == 200) {
                                    imageFile =xhr.responseText;
                                    output.innerHTML += imageFile;
                                    
                                } else {
                                    output.innerHTML += "Error " + xhr.status + " occurred uploading your file.<br />";
                                }                        

                                // string generated by canvas.toDataURL()
                                // Grab the extension to resolve any image error
                                
                                
                                //var ext = imgURL.split(';')[0].match(/jpeg|png|gif/)[0];
                                
                                // strip off the data: url prefix to get just the base64-encoded bytes
                                
                                
/*                                 var data = imgURL.replace(/^data:image\/\w+;base64,/, "");
                                var buf = new Buffer(data, 'base64');
                                console.log(data);
                                console.log(fs);
                                fs.writeFile('image.' + ext, buf);                    
 */                                

                            }
                            catch (e) {
                                try {
                                    // Fallback if createObjectURL is not supported
                                    var fileReader = new FileReader();
                                    fileReader.onload = function (event) {
                                        showPicture.src = event.target.result;
                                    };
                                    fileReader.readAsDataURL(file);
                                }
                                catch (e) {
                                    //
                                    var error = document.querySelector("#error");
                                    if (error) {
                                        error.innerHTML = "Neither createObjectURL or FileReader are supported";
                                    }
                                }
                            }
                        }
                    };
                }
            })();        
        </script>


    </body>

</html>